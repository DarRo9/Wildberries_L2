Что выведет программа? Объяснить вывод программы. Объяснить как работают defer’ы и порядок их вызовов.

package main
 
import (
    "fmt"
)
 
func test() (x int) {
    defer func() {
        x++
    }()
    x = 1
    return
}
 
 
func anotherTest() int {
    var x int
    defer func() {
        x++
    }()
    x = 1
    return x
}
 
 
func main() {
    fmt.Println(test())
    fmt.Println(anotherTest())
}

Ответ:

2
1
Правила работы defer:

Аргументы отложенной функции оцениваются при вычислении оператора defer:

1. Отложенные вызовы функций выполняются в порядке «последним пришел — первым обслужен» (LIFO) после возврата из основной функции;
2. Отложенные функции могут считывать и присваивать именованные возвращаемые значения возвращаемой функции.
3. В нашем примере, функция test попадает под третье правило, поэтому функции defer удается увеличить переменную.

В функции test() отложенная функция выполняется после обновления именованного результата функции и поэтому меняет значение результата (работает 3-е правило).

А в функции anotherTest, defer не влияет на вывод, потому что оператор defer не будет выполняться до тех пор пока окружающая его функция не
завершит свое выполнение. Операторы defer вызываются по принципу LIFO.
